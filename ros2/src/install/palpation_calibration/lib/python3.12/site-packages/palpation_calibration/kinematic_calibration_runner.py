import rclpy
from rclpy.node import Node
import numpy as np
import csv
import time

from sensor_msgs.msg import JointState
from geometry_msgs.msg import PoseStamped


def quat_to_vec(q):
    return np.array([q.x, q.y, q.z, q.w])


def quat_angle(q1, q2):
    dot = abs(np.dot(q1, q2))
    dot = np.clip(dot, -1.0, 1.0)
    return 2.0 * np.arccos(dot) * 180.0 / np.pi


class CalibrationRunner(Node):

    def __init__(self):
        super().__init__('kinematic_calibration_runner')

        # ---- Publishers / Subscribers ----
        self.jp_pub = self.create_publisher(
            JointState,
            '/ves/left/joint/setpoint_jp',
            10
        )

        self.jp_sub = self.create_subscription(
            JointState,
            '/ves/left/joint/setpoint_jp',
            self.jp_callback,
            10
        )

        self.ndi_sub = self.create_subscription(
            PoseStamped,
            '/sensor_pose_raw',
            self.ndi_callback,
            10
        )

        # ---- State ----
        self.last_ndi_pos = None
        self.last_ndi_quat = None
        self.last_stable_time = None

        self.current_ndi_pos = None
        self.current_ndi_quat = None
        self.current_joints = None

        # ---- Logging ----
        self.csv = open('calib_stage1_inner.csv', 'w', newline='')
        self.writer = csv.writer(self.csv)
        self.writer.writerow([
            'theta_in', 'theta_out', 'd_in_mm', 'd_out_mm',
            'px_mm', 'py_mm', 'pz_mm',
            'qx', 'qy', 'qz', 'qw'
        ])

        # ---- Calibration command list ----
        self.commands = self.build_commands()
        self.cmd_idx = 0

        self.get_logger().info(f"Prepared {len(self.commands)} calibration poses")

        self.timer = self.create_timer(0.02, self.update)

    # --------------------------------------------------

    def build_commands(self):
        cmds = []

        theta_out = 0.0
        d_out = 0.0

        for d_in in np.linspace(5.0, 40.0, 10):
            cmds.append([
                0.0,        # theta_in
                theta_out,  # theta_out
                d_in,       # inner translation (mm)
                d_out,      # outer translation (mm)
                0.0         # tool
            ])
        return cmds

    # --------------------------------------------------

    def jp_callback(self, msg):
        self.current_joints = msg.position

    def ndi_callback(self, msg):
        p = msg.pose.position
        q = msg.pose.orientation

        self.current_ndi_pos = np.array([p.x, p.y, p.z])  # mm
        self.current_ndi_quat = quat_to_vec(q)

    # --------------------------------------------------

    def publish_command(self, q):
        msg = JointState()
        msg.position = q
        self.jp_pub.publish(msg)

    # --------------------------------------------------

    def is_stable(self):
        if self.last_ndi_pos is None:
            self.last_ndi_pos = self.current_ndi_pos
            self.last_ndi_quat = self.current_ndi_quat
            self.last_stable_time = time.time()
            return False

        dp = np.linalg.norm(self.current_ndi_pos - self.last_ndi_pos)
        dtheta = quat_angle(self.current_ndi_quat, self.last_ndi_quat)

        self.last_ndi_pos = self.current_ndi_pos
        self.last_ndi_quat = self.current_ndi_quat

        if dp < 0.5 and dtheta < 1.0:
            if time.time() - self.last_stable_time > 0.4:
                return True
        else:
            self.last_stable_time = time.time()

        return False

    # --------------------------------------------------

    def log_sample(self):
        q = self.current_joints
        p = self.current_ndi_pos
        quat = self.current_ndi_quat

        self.writer.writerow([
            q[0], q[1], q[2], q[3],
            p[0], p[1], p[2],
            quat[0], quat[1], quat[2], quat[3]
        ])

        self.get_logger().info(f"Logged sample {self.cmd_idx+1}")

    # --------------------------------------------------

    def update(self):
        if self.cmd_idx >= len(self.commands):
            self.get_logger().info("Calibration data collection complete.")
            self.csv.close()
            rclpy.shutdown()
            return

        if self.current_ndi_pos is None or self.current_joints is None:
            return

        if self.last_stable_time is None:
            self.publish_command(self.commands[self.cmd_idx])
            return

        if self.is_stable():
            self.log_sample()
            self.cmd_idx += 1
            self.last_stable_time = None

        else:
            self.publish_command(self.commands[self.cmd_idx])


def main():
    rclpy.init()
    node = CalibrationRunner()
    rclpy.spin(node)


if __name__ == '__main__':
    main()
